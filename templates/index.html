<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ListenBack - RAG Chatbot for Lectures</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f4f6fa;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
            padding: 32px 24px;
        }

        h1 {
            text-align: center;
            margin-bottom: 32px;
            color: #2d3a4b;
        }

        .main-flex {
            display: flex;
            gap: 32px;
            flex-wrap: wrap;
        }

        .left-col {
            flex: 2 1 400px;
            min-width: 320px;
        }

        .right-col {
            flex: 1 1 320px;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .card {
            background: #f9fafb;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
            margin-bottom: 24px;
            padding: 24px;
        }

        .video-box {
            margin-bottom: 18px;
        }

        video {
            width: 100%;
            border-radius: 8px;
            background: #222;
        }

        .transcript-box {
            max-height: 260px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #e3e6ee;
            border-radius: 8px;
            padding: 16px;
            font-size: 15px;
            color: #333;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 420px;
            background: #fff;
            border: 1px solid #e3e6ee;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            overflow-y: auto;
        }

        .user-message {
            background: #e3f2fd;
            color: #1a237e;
            align-self: flex-end;
            border-radius: 12px 12px 0 12px;
            margin: 6px 0;
            padding: 10px 16px;
            max-width: 80%;
        }

        .bot-message {
            background: #f0f0f0;
            color: #333;
            align-self: flex-start;
            border-radius: 12px 12px 12px 0;
            margin: 6px 0;
            padding: 10px 16px;
            max-width: 80%;
        }

        .chat-form {
            display: flex;
            gap: 8px;
        }

        .chat-form input[type="text"] {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #bfc7d1;
            border-radius: 6px;
            font-size: 15px;
        }

        .chat-form button {
            background: #3b82f6;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 10px 18px;
            font-size: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-form button:hover {
            background: #2563eb;
        }

        .upload-area {
            border: 2px dashed #bfc7d1;
            border-radius: 8px;
            padding: 32px 16px;
            text-align: center;
            background: #f5f7fa;
            margin-bottom: 18px;
        }

        .upload-area.active {
            border-color: #3b82f6;
            background: #e0e7ff;
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: 10px;
        }

        .spinner {
            border: 4px solid #e3e6ee;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 900px) {
            .main-flex {
                flex-direction: column;
                gap: 0;
            }

            .right-col {
                margin-top: 32px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ListenBack - RAG Chatbot for Lectures</h1>
        <div id="upload-section" class="card">
            <div class="upload-area" id="drop-area">
                <form id="upload-form" enctype="multipart/form-data">
                    <p>Drag & drop your file here, or click to select</p>
                    <input type="file" id="file-input" accept="audio/*,video/*" style="display:none;">
                    <button type="button" id="select-file-btn">Select File</button>
                    <span id="file-name" style="margin-left:10px;color:#555;"></span>
                    <div style="margin-top:18px;">
                        <button type="submit" id="upload-button">Upload & Process</button>
                    </div>
                </form>
            </div>
            <div class="loading" id="upload-loading">
                <div class="spinner"></div>
                <p style="margin-top:10px;">Processing file... This may take a few minutes.</p>
            </div>
            <div id="upload-success" style="display:none;color:green;margin-top:10px;">File processed successfully! You
                can now ask questions about the content.</div>
            <div id="upload-error" style="display:none;color:red;margin-top:10px;"></div>
        </div>
        <div id="content-section" class="main-flex" style="display:none;">
            <div class="left-col">
                <div class="card video-box" id="video-card" style="display:none;">
                    <h3 style="margin-bottom:12px;">Video</h3>
                    <video id="video-player" controls>
                        <source id="video-source" src="" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <h3 style="margin:0;">Transcript</h3>
                        <button id="new-upload"
                            style="background:#eee;border:none;padding:6px 14px;border-radius:5px;cursor:pointer;">Upload
                            New File</button>
                    </div>
                    <div id="transcript-content" class="transcript-box"></div>
                </div>
            </div>
            <div class="right-col">
                <div class="chat-container" id="chat-messages">
                    <div class="bot-message">Hello! I'm ready to answer questions about the uploaded lecture. What would
                        you like to know?</div>
                </div>
                <form id="question-form" class="chat-form">
                    <input type="text" id="question-input" placeholder="Type your question here...">
                    <button type="submit">Ask</button>
                </form>
                <div class="loading" id="question-loading">
                    <div class="spinner"></div>
                    <p style="margin-top:10px;">Thinking...</p>
                </div>
            </div>
        </div>
        <script>
            // Elements
            const uploadForm = document.getElementById('upload-form');
            const fileInput = document.getElementById('file-input');
            const selectFileBtn = document.getElementById('select-file-btn');
            const fileName = document.getElementById('file-name');
            const uploadButton = document.getElementById('upload-button');
            const uploadLoading = document.getElementById('upload-loading');
            const uploadSuccess = document.getElementById('upload-success');
            const uploadError = document.getElementById('upload-error');
            const uploadSection = document.getElementById('upload-section');
            const contentSection = document.getElementById('content-section');
            const transcriptContent = document.getElementById('transcript-content');
            const videoCard = document.getElementById('video-card');
            const videoPlayer = document.getElementById('video-player');
            const videoSource = document.getElementById('video-source');
            const chatMessages = document.getElementById('chat-messages');
            const questionForm = document.getElementById('question-form');
            const questionInput = document.getElementById('question-input');
            const questionLoading = document.getElementById('question-loading');
            const newUploadBtn = document.getElementById('new-upload');
            const dropArea = document.getElementById('drop-area');

            // File select button
            selectFileBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length) {
                    fileName.textContent = fileInput.files[0].name;
                }
            });

            // Drag and drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.add('active'), false);
            });
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.remove('active'), false);
            });
            dropArea.addEventListener('drop', handleDrop, false);
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                    fileName.textContent = files[0].name;
                }
            }

            // Upload
            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const file = fileInput.files[0];
                if (!file) {
                    uploadError.textContent = 'Please select a file first.';
                    uploadError.style.display = 'block';
                    return;
                }
                const formData = new FormData();
                formData.append('file', file);
                uploadButton.disabled = true;
                uploadLoading.style.display = 'block';
                uploadError.style.display = 'none';
                uploadSuccess.style.display = 'none';
                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (response.ok && result.success) {
                        uploadSuccess.style.display = 'block';
                        // Show transcript
                        transcriptContent.textContent = result.transcript || '';
                        // Show video if present
                        if (result.video_path) {
                            videoSource.src = result.video_path;
                            videoPlayer.load();
                            videoCard.style.display = '';
                        } else {
                            videoCard.style.display = 'none';
                        }
                        setTimeout(() => {
                            uploadSection.style.display = 'none';
                            contentSection.style.display = 'flex';
                        }, 1200);
                    } else {
                        throw new Error(result.error || 'Upload failed');
                    }
                } catch (error) {
                    uploadError.textContent = `Error: ${error.message}`;
                    uploadError.style.display = 'block';
                } finally {
                    uploadButton.disabled = false;
                    uploadLoading.style.display = 'none';
                }
            });
            // Chat
            questionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const question = questionInput.value.trim();
                if (!question) return;
                addMessage(question, 'user');
                questionInput.value = '';
                questionInput.disabled = true;
                questionForm.querySelector('button').disabled = true;
                questionLoading.style.display = 'block';
                try {
                    const formData = new FormData();
                    formData.append('question', question);
                    const response = await fetch('/query', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (response.ok) {
                        addMessage(result.answer, 'bot');
                    } else {
                        throw new Error(result.detail || 'Failed to get answer');
                    }
                } catch (error) {
                    addMessage(`Error: ${error.message}`, 'bot');
                } finally {
                    questionInput.disabled = false;
                    questionForm.querySelector('button').disabled = false;
                    questionLoading.style.display = 'none';
                }
            });
            // New upload
            newUploadBtn.addEventListener('click', () => {
                uploadSection.style.display = '';
                contentSection.style.display = 'none';
                uploadSuccess.style.display = 'none';
                uploadError.style.display = 'none';
                fileInput.value = '';
                fileName.textContent = '';
                videoCard.style.display = 'none';
                transcriptContent.textContent = '';
                // Clear chat messages except the first one
                while (chatMessages.children.length > 1) {
                    chatMessages.removeChild(chatMessages.lastChild);
                }
            });
            function addMessage(text, sender) {
                const div = document.createElement('div');
                div.className = sender === 'user' ? 'user-message' : 'bot-message';
                div.textContent = text;
                chatMessages.appendChild(div);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        </script>
    </div>
</body>

</html>